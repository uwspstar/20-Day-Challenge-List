### 动态图：展示系统运行时的行为

**动态图**（Dynamic Diagram）是 C4 模型中的一种图表，专注于展示系统在**运行时**的行为，具体来说就是在某个时刻，系统中的组件或容器之间如何进行交互和传递信息。动态图的目标是帮助开发者理解系统的动态流程，揭示系统在执行具体功能时的内部工作原理。

---

### 创建动态图的步骤

为了构建动态图，我们需要展示一个具体的操作流程，例如用户发起的某个请求在系统中的流转过程。以下是一个常见应用的动态图示例——**在线购物系统**的订单创建和支付流程。

#### 操作场景：用户在购物网站上下单并支付

用户在购物网站上完成订单，系统需要执行以下主要步骤：
1. 用户提交订单。
2. 系统创建订单并验证库存。
3. 系统与支付网关交互处理支付。
4. 系统确认订单并通知用户。

---

### 动态图设计

以下动态图展示了系统在处理订单创建和支付流程时的运行时行为：

```
用户 ----> [Web 应用] ----> [订单服务]
                            |
                            v
                     [库存服务] <----> [数据库]
                            |
                            v
                    [支付服务] ----> [支付网关]
                            |
                            v
                     [消息系统]
```

---

### 动态图中的组件解释

#### 1. **用户**
- 用户在 Web 应用中下单，触发整个订单流程的开始。

#### 2. **Web 应用**
- **职责**：Web 应用接收用户订单请求，并将请求传递给订单服务进行处理。
- **交互**：将订单请求发送给订单服务，同时等待订单处理完成后，返回确认信息给用户。

#### 3. **订单服务**
- **职责**：处理用户订单的创建、库存验证、支付请求等一系列操作。
- **交互**：
  - 调用库存服务检查商品是否有库存。
  - 调用支付服务发起支付请求。
  - 在所有操作成功后，将订单确认信息返回给 Web 应用。

#### 4. **库存服务**
- **职责**：验证商品库存是否足够处理订单请求。
- **交互**：与数据库交互，查询和更新库存数据。如果库存不足，会返回失败信息给订单服务。

#### 5. **支付服务**
- **职责**：处理支付请求，将请求传递给外部支付网关。
- **交互**：
  - 向支付网关发送支付请求。
  - 接收支付网关的响应并将支付结果传递给订单服务。

#### 6. **支付网关**
- **职责**：处理来自支付服务的实际支付请求。
- **交互**：接收支付服务的请求，与银行或支付平台交互完成支付。

#### 7. **消息系统**
- **职责**：在订单完成或支付完成后，向用户发送通知（如订单确认、支付成功）。
- **交互**：接收来自订单服务或支付服务的事件，并发送电子邮件或短信通知用户。

---

### 动态图的运行流程

1. **用户提交订单请求**：用户通过 Web 应用提交订单，Web 应用将请求发送到订单服务。
2. **订单服务验证库存**：订单服务调用库存服务，验证商品库存是否足够处理该订单。
   - 如果库存不足，订单服务会返回库存不足的消息给 Web 应用，终止订单处理。
   - 如果库存充足，订单服务继续处理订单。
3. **订单服务发起支付请求**：订单服务将订单信息发送给支付服务，发起支付请求。
4. **支付服务与支付网关交互**：支付服务将支付请求发送到支付网关，支付网关处理支付并返回支付结果。
5. **订单确认和通知**：
   - 支付完成后，订单服务确认订单创建成功，并将确认信息返回给 Web 应用，Web 应用将订单确认信息展示给用户。
   - 同时，订单服务通过消息系统发送订单确认或支付成功的通知给用户。

---

### 小结

**动态图**展示了系统在运行时如何处理特定请求或事件，帮助我们理解组件之间的交互和数据流动。在这个例子中，我们展示了一个完整的订单创建和支付流程，清晰地呈现出各个组件如何在运行时协同工作。

**关键点**：
- 动态图适合展示系统在执行某个具体功能时的行为流程。
- 动态图能帮助开发者理解复杂操作背后的工作机制，揭示系统中的信息流和调用链。
- 通过这种图示，可以更容易进行问题排查、优化系统性能和增强系统的可维护性。
